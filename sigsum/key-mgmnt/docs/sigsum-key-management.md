# Key management

This document provides a key management strategy using Tillitis
[Tkey][]. It's intended use is to manage private Ed25519 keys for
[Sigsum][] log servers and witnesses.

[Tkey]: https://www.tillitis.se/products/tkey/
[Sigsum]: https://www.sigsum.org

## Introduction

An introduction on Tillitis TKey inner workings can be found in this
[blog post][] and more detailed information can be found in the
[Tillitis TKey repository][] on GitHub. TKey [threat model] can be
good to also read.

It is also good to read up on how to install and setup [Tkey SSH
Agent][]. More details can be found in the
[tkey-ssh-agent repository][].

Also, [TKey Random Number Generator][] (with [diceware][]) will be used
to generate random passphrases (USS).

[Age][] together with each employees personal TKey is used for
encrypting/decrypting passphrases (USS).

[blog post]: https://www.tillitis.se/blog/2023/03/31/on-tkey-key-generation/
[Tillitis TKey repository]: https://github.com/tillitis/tillitis-key1
[threat model]: https://github.com/tillitis/tillitis-key1/blob/main/doc/threat_model/threat_model.md
[Tkey SSH Agent]: https://www.tillitis.se/applications/tkey-ssh-agent/
[tkey-ssh-agent repository]: https://github.com/tillitis/tkey-ssh-agent/
[TKey Random Number Generator]: https://www.tillitis.se/applications/tkey-random-number-generator/
[diceware]: https://github.com/tillitis/tkey-random-generator/tree/diceware
[Age]: https://github.com/FiloSottile/age

## Overview

The overall objectives are:

1. Signing requires access to an always attached TKey and a 256-bit
   secret (CDI - [Compound Device Id][]) generated when the TKey was
started. This _signing TKey_ is plugged into a networked node at all
times (i.e., a primary log server, a secondary log server, or a
witness), and is only usable as a signing TKey if a passphrase (USS)
is made available.
2. Re-provisioning requires access to a _backup TKey_ and the
   passphrase (USS).
3. UDS for a _signing TKey_ and its backup TKey is identical. As a
   last resort the UDS is also noted on paper and stored separatley in
a tamper-evident bag. Retaining the UDS ensures long-term key
continuity even if hardware fails.
4. Secret passphrases (USS) is stored encrypted (with age) and can
   only be decrypted by employees with their personal TKey.
5. A single trusted operator can gain access to all TKeys, UDS and USS
   needed to make use of them.

## Threat Model

Above objectives implies a threat model where operators must be
trusted.  In other words, what we are trying to protect against are
external threats and failures. Examples of threats include a device
that gets physically stolen or remotely accessible as a result of a
networked node being owned. Examples of failures include devices that
break.

[Randomness produced by a TKey][] is assumed to be good, so that the
generated passphrase is computationally hard to brute force.

For key recovery, the attacker needs to gain access to a backup TKey
and its secret passphrase (USS). This is assumed to be hard: one
physical security boundary, one cryptographic boundary need to be
breached at the same time for the attacker to succeed.

For signing access, a (local) attacker can steal a node's TKey and
breach one cryptographic boundary to gain access to its passphrase
(USS). This, too, is assumed to be hard.

For signing access, a (remote) attacker may gain root access on an
active node. This may be the most likely attack scenario.  It is also
hard to detect if no physical boundary is breached.

For creating a copy of TKey, the attacker needs to breach one physical
security boundary and one cryptographic security boundary to obtain
UDS and USS. This is assumed to be hard.

For physical security and detection of breaches we rely on locks,
alarms, safes, tamper-evident bags, etc.  Detection of a breach is
generally assumed to be rapid and obvious; but as a defense-in-depth
we also do a few routine checks.

[Randomness produced by a TKey]: https://www.tillitis.se/blog/2024/05/27/high-quality-noise-in-a-fpga-how-the-tkey-trng-works/
[Compound Device Id]: https://www.tillitis.se/blog/2023/03/31/on-tkey-key-generation/

## Description

### Unique Device Secret (UDS)

Unique Device Secret (UDS) is the base secret in TKey. Each _signing
TKey_ and its corresponding backup TKey has the same UDS. To be able
to create more backup TKey's due to damage or other hardware
malfunction UDS is also noted on paper and stored in tamper evident
bag.

UDS is a 256-bit random number generated with `TKey Random Generator`.

**Routine:** Check tamper-evident bag every month. Open bag every
third month and check note.

### Secret passphrase (USS)

Secret passphrase (USS) is used by TKey in the key derivation
function. The passphrase is generated by using the `TKey
Random Generator` with `diceware`. The passphrase generated shall
consist of at least six words.

Secret passphrase is stored in an age encrypted file, with recipients
set to all employees at Tillitis. Employees shall create their age
identity with their personal TKey, which means their TKey is needed
for decrypting the file. File is stored on local server and on one USB
memory (for redundancy reason).

**Routine:** Check by decrypting age files every three months.

### Backup TKey

We have one backup TKey that is a complete replicate of the _signing
TKey_. A backup TKey reduces recovery time if the _signing TKey_ needs
to be replaced.

Backup TKey is stored in a tamper-evident bag on a secure location.

If it is detected that a backup TKey is malfunctioning (e.g., hardware
failure), re-provision so that there is a new backup TKey.

**Routine:** check that the backup TKey works, with
`tkey-verification` every three months.

### Signing TKey

The signing TKey creates it keys(s) at startup when the device app is
loaded onto TKey and secret passphrase (USS) is provided at request.
Secret passphrase is manually written in the pin entry dialog box. See
[above](#secret-passphrase-uss) how passphrase is retrieved.

If it is detected that a signing TKey is malfunctioning or broken in
some way, destroy the signing TKey, install the backup TKey and
provision a new backup TKey.

**Routine:** Automate checks that verify if a node's TKey is plugged-in.

### Tamper-Evident Bags

Below is an example of a table that could be tracked in a git repository.  E.g.,
before opening a tamper-evident bag and subsequently replacing it, one would
confirm with the others that they currently have and still get the same table.

| Date       | Storage location | Device       | Bag serial number | Notes                    |
|------------|------------------|--------------|-------------------|--------------------------|
| YYYY-MM-DD | Location A       | TKey1 backup | 000002            | Initial provisioning     |

## Getting started

### Equipment

- 2x TKeys to provision
- 1x provisioning machine configured with [tools needed](#introduction)
- 1x USB memory
- 1x git repository
- Many tamper-evident bags

### Locations

- 1x physically secure site for backup TKey and provisioning machine
- Secure site(s) where the machines with online TKeys are operated

### Provisioning

Provisioning shall be done on a provisioning machine that is not
connected to any network.

Take 2 TKeys from ordinary production flow, before provisioning step.
On provisioning machine generate random UDS and provision one
_signing TKey_ and one backup TKey with this UDS. Note UDS on paper
and store paper in a tamper-evident bag. Populate the git repository
table with initial storage location and serial number of bag.

Run:

`./tkey-diceware -words x | age --encrypt -a -R ./recipients > encrypted_file`

This will create a passphrase with x words and encrypt the output with
age. Recipients should be listed in the file `recipients`. Output will
be saved in the file `encrypted_file`. When provisioning passphrase
shall be at least 6 words long, i.e. `x` => 6.

The recipients age identity shall be created with their respective
TKey. To decrypt the user will need it's TKey and run:

`age -i id_file --decrypt encrypted_file`

Save encrypted file on local server and the USB memory and put the USB
memory in tamper-evident bag. Populate the git repository table with
initial storage locations and serial numbers of bags.

Put backup TKey into tamper-evident bag. Populate the git repository
table with initial storage location and serial number of bag.

Transport the different items to their distinct storage locations.
Plug _signing TKey_ into the networked node, or store it in the same
physical location as the backup TKey until they it's ready to be used.

Appoint someone to be responsible for following up on routine checks.

If it is desired to showcase to others that this provision ceremony
was used, optionally invite one or more independent parties to witness
and take notes.
